# 依存関係の更新計画

## Node.js バージョン要件

**現在のサポート範囲:** Node.js 20.x, 22.x, 24.x

- ❌ **Node.js 18.x** - 2025年4月30日にEOL（サポート終了）
- ✅ **Node.js 20.x** - Maintenance LTS（2026年4月30日までサポート）
- ✅ **Node.js 22.x** - Maintenance LTS（2027年4月30日までサポート）
- ⭐ **Node.js 24.x** - Active LTS（推奨バージョン、2025年10月28日～）

**推奨開発環境:** Node.js 24.x（.nvmrcで指定）

## 現在の依存関係

### 本番依存関係 (dependencies)
- `fumble@^0.1.0` - Yahoo!製エラーハンドリングライブラリ

### 開発依存関係 (devDependencies)

#### 優先度：高（セキュリティ・安定性）

1. **express** `^4.17.1` → `^4.21.2`
   - 現在: 2021年リリース
   - 最新: 4.21.2 (複数のセキュリティ修正を含む)
   - 影響: テストとサンプルコードのみ
   - 破壊的変更: なし（マイナーアップデート）
   - リスク: 🟢 低

2. **webpack** `^5.51.1` → `^5.97.1`
   - 現在: 2021年リリース
   - 最新: 5.97.1
   - 影響: サンプルのビルドのみ
   - 破壊的変更: なし（マイナーアップデート）
   - リスク: 🟢 低

3. **chai** `^4.2.0` → `^5.1.2`
   - 現在: 2019年リリース
   - 最新: 5.1.2 (メジャーアップデート)
   - 影響: テストコード
   - 破壊的変更: あり（メジャーアップデート）
   - Node.js 18+が必要（すでに対応済み）
   - リスク: 🟡 中

4. **mocha** `^10.0.0` → `^10.8.2`
   - 現在: 2022年リリース
   - 最新: 10.8.2
   - 影響: テストフレームワーク
   - 破壊的変更: なし（マイナーアップデート）
   - リスク: 🟢 低

5. **sinon** `^19.0.2` → `^19.0.2`
   - 現在: 最新
   - アクション: なし

6. **playwright** `^1.49.1` (puppeteerから移行)
   - 移行理由: より優れたCI/CD統合、複数ブラウザ対応
   - 影響: ブラウザテスト
   - 破壊的変更: APIの書き換えが必要
   - リスク: 🟡 中（テストコードの書き換え完了済み）

#### 優先度：中（機能性・互換性）

7. **node-fetch** `^2.6.2` → `^3.3.2` または維持
   - 現在: v2 (CommonJS)
   - 最新: v3 (Pure ESM)
   - 影響: **破壊的変更あり** - v3は完全ESM
   - 推奨: **v2を維持**（プロジェクトがCommonJSのため）
   - 代替案: Native Fetch API（Node.js 18+）への移行を検討
   - リスク: 🔴 高（v3へのアップグレード時）

8. **fetch-mock** `^10.1.1` → `^12.0.2`
   - 現在: 2022年リリース
   - 最新: 12.0.2 (メジャーアップデート)
   - 影響: テストコード
   - 破壊的変更: あり（node-fetch v3への対応）
   - リスク: 🟡 中

9. **abortcontroller-polyfill** ~~`^1.7.3`~~ → **削除済み**
   - Node.js 20+では完全に不要（ネイティブサポート）
   - AbortController: Node.js 15.0.0+で標準実装
   - fetch: Node.js 21.0.0+で安定版
   - 影響: tests/unit/setup.jsを書き換え済み
   - リスク: 🟢 低（削除完了）

10. **nyc** `^17.0.0` → `^17.1.0`
    - 現在: 17.0.0
    - 最新: 17.1.0
    - 影響: カバレッジレポート
    - 破壊的変更: なし（マイナーアップデート）
    - リスク: 🟢 低

11. **supertest** `7.0.0` → `^7.0.0`
    - 現在: 最新
    - アクション: キャレット(^)を追加

12. **mockery** `^2.0.0` → `^2.1.0`
    - 現在: 2.0.0
    - 最新: 2.1.0
    - 影響: モジュールモック
    - 破壊的変更: なし（マイナーアップデート）
    - リスク: 🟢 低

## 更新の段階的アプローチ

### フェーズ1: 低リスクの更新（即座に実行可能）
```bash
pnpm add -D express@^4.21.2 webpack@^5.97.1 mocha@^10.8.2 \
  puppeteer@^23.12.0 abortcontroller-polyfill@^1.7.6 \
  nyc@^17.1.0 mockery@^2.1.0
```

**テスト:**
- `pnpm test` - 全テストスイートの実行
- `pnpm run lint` - Lintチェック

### フェーズ2: 中リスクの更新（テスト要）
```bash
# Chai v5へのアップグレード
pnpm add -D chai@^5.1.2
```

**検証が必要な項目:**
- アサーションのAPIに変更がないか
- テストコードの動作確認
- 型定義の互換性（TypeScript使用時）

**テスト:**
- 全ユニットテスト、機能テストの実行
- アサーション関連のコードを重点的にチェック

### フェーズ3: 検討事項（慎重な計画が必要）

#### node-fetchの扱い

**オプションA: v2を維持（推奨）**
```bash
pnpm add -D node-fetch@^2.7.0
```
- 最もリスクが低い
- CommonJSとの互換性維持

**オプションB: Native Fetch APIへ移行**
- Node.js 18+では`fetch`がグローバルに利用可能
- `node-fetch`依存を削除できる
- テストコードの書き換えが必要

**オプションC: v3へのアップグレード（非推奨）**
```bash
pnpm add -D node-fetch@^3.3.2
```
- ESM対応が必須
- プロジェクト全体のESM移行が前提

#### fetch-mockの更新
- node-fetchの決定に依存
- node-fetch v2を維持する場合、fetch-mockも現バージョンを維持

## 実装スケジュール

1. **Week 1: フェーズ1実行**
   - 低リスクの依存関係を更新
   - 全テストスイート実行
   - CI/CDで検証

2. **Week 2: フェーズ2実行**
   - Chai v5へのアップグレード
   - テストコードの互換性確認
   - 必要に応じてテストコードを修正

3. **Week 3-4: フェーズ3検討**
   - node-fetchの方針決定
   - Native Fetch APIへの移行を評価
   - 必要に応じてテストコードをリファクタリング

## 追加の推奨事項

### 依存関係の監視ツール

**Renovateまたは Dependabotの設定:**
```json
// .github/renovate.json
{
  "extends": ["config:base"],
  "packageRules": [
    {
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true
    }
  ]
}
```

### セキュリティ監査の定期実行
```bash
pnpm audit
pnpm audit --fix
```

### package.jsonの依存関係範囲の見直し
- `^` (キャレット): マイナー・パッチ更新を許可
- `~` (チルダ): パッチ更新のみを許可
- 固定バージョン: 更新を許可しない

**推奨:**
- 開発依存関係: `^` を使用（柔軟性）
- 本番依存関係: 慎重に（`~` または固定）

## リスク管理

### テスト戦略
1. 各フェーズ後に完全なテストスイートを実行
2. CI/CDパイプラインでの自動検証
3. ローカル環境での手動テスト

### ロールバック計画
- Gitコミットを各フェーズごとに分離
- 問題発生時は即座に`git revert`
- package.jsonとlockファイルのバックアップ

### 互換性マトリクス
| パッケージ | 現在 | 目標 | Node.js 18 | Node.js 20 | Node.js 22 |
|-----------|------|------|-----------|-----------|-----------|
| express | 4.17.1 | 4.21.2 | ✅ | ✅ | ✅ |
| webpack | 5.51.1 | 5.97.1 | ✅ | ✅ | ✅ |
| mocha | 10.0.0 | 10.8.2 | ✅ | ✅ | ✅ |
| chai | 4.2.0 | 5.1.2 | ✅ | ✅ | ✅ |
| node-fetch | 2.6.2 | 2.7.0 | ✅ | ✅ | ✅ |

## まとめ

この計画に従うことで、段階的かつ安全に依存関係を最新化できます。各フェーズでテストを実行し、問題が発生した場合は即座にロールバックすることで、プロジェクトの安定性を維持します。
